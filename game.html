<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Golf Game</title>
  <style>
    body { text-align: center; background: #e8f8e8; font-family: Arial, sans-serif; }
    #game-canvas { border: 1px solid #000; margin-top: 20px; }
    #wallet-info, #leaderboard { display: none; margin-top: 20px; }
    button, input { margin: 10px; padding: 10px; font-size: 16px; }
    #loading-spinner { display: none; margin-top: 20px; }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@latest/dist/browser/index.iife.min.js"></script>
</head>
<body>

<h1>üèåÔ∏è‚Äç‚ôÇÔ∏è Solana Golf Game ($SHUFF Version)</h1>

<button id="connect-wallet-btn">Connect Wallet</button>

<div id="wallet-info">
  <p>Wallet Address: <span id="wallet-address"></span></p>
</div>

<input type="number" id="swing-amount" placeholder="Enter amount ($SHUFF)" min="0.001" step="0.001">
<button id="swing-btn" disabled>Swing!</button>

<div id="status"></div>

<div id="loading-spinner">
  <div class="spinner"></div>
  <p>Processing transaction...</p>
</div>

<canvas id="game-canvas" width="800" height="400"></canvas>

<div id="leaderboard">
  <h2>üèÜ Leaderboard</h2>
  <ul id="leaderboard-list"></ul>
</div>

<script>
// Globals
let walletAddress = null;
const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
const treasuryWallet = new solanaWeb3.PublicKey('649fCzukZDSWwmhjQSAEJCyW6LXN8TDj5ytFxVtFv4ry');
const shuffMint = new solanaWeb3.PublicKey('GGnZQxAcBXvhKJFX7bRosBhbm8v4uFBeBuTnZsfapump'); // SHUFF token mint

async function connectWallet() {
  try {
    const resp = await window.solana.connect();
    walletAddress = resp.publicKey.toString();
    document.getElementById('wallet-address').innerText = walletAddress;
    document.getElementById('wallet-info').style.display = 'block';
    document.getElementById('swing-btn').disabled = false;
  } catch (err) {
    console.error(err);
    alert('Wallet connection failed!');
  }
}

async function sendTransaction(amount) {
  const loadingSpinner = document.getElementById('loading-spinner');
  try {
    loadingSpinner.style.display = 'block';

    const provider = window.solana;
    const fromWallet = provider.publicKey;
    const fromTokenAccount = await splToken.getAssociatedTokenAddress(shuffMint, fromWallet);
    const toTokenAccount = await splToken.getAssociatedTokenAddress(shuffMint, treasuryWallet);

    // Create destination token account if it doesn't exist
    const toTokenAccountInfo = await connection.getAccountInfo(toTokenAccount);
    const instructions = [];
    if (!toTokenAccountInfo) {
      instructions.push(
        splToken.createAssociatedTokenAccountInstruction(
          fromWallet,
          toTokenAccount,
          treasuryWallet,
          shuffMint
        )
      );
    }

    // 25% of amount to send
    const sendAmount = BigInt(Math.floor(amount * 0.25 * 1e9)); // SHUFF uses 9 decimals

    instructions.push(
      splToken.createTransferInstruction(
        fromTokenAccount,
        toTokenAccount,
        fromWallet,
        sendAmount
      )
    );

    const latestBlockhash = await connection.getLatestBlockhash();
    const transaction = new solanaWeb3.Transaction({
      recentBlockhash: latestBlockhash.blockhash,
      feePayer: fromWallet,
    }).add(...instructions);

    const signedTx = await provider.signTransaction(transaction);
    const signature = await connection.sendRawTransaction(signedTx.serialize());
    await connection.confirmTransaction(signature);

    document.getElementById('status').innerText = 'üèåÔ∏è‚Äç‚ôÇÔ∏è Swing successful!';
    animateGolfBall();
    updateLeaderboard(walletAddress, amount);
  } catch (err) {
    console.error(err);
    alert('Transaction failed!');
  } finally {
    loadingSpinner.style.display = 'none';
  }
}

function animateGolfBall() {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  let x = 50, y = 300;
  let vx = 10;
  let vy = -18;
  const gravity = 0.6;
  const friction = 0.98;
  const ground = canvas.height - 10;
  let rolling = false;

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.beginPath();
    ctx.arc(x, y, 10, 0, Math.PI * 2);
    ctx.fillStyle = 'white';
    ctx.fill();
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(0, ground);
    ctx.lineTo(canvas.width, ground);
    ctx.strokeStyle = 'green';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function update() {
    if (!rolling) {
      x += vx;
      y += vy;
      vy += gravity;

      if (y >= ground) {
        y = ground;
        vy = 0;
        rolling = true;
      }
    } else {
      x += vx;
      vx *= friction;
      if (Math.abs(vx) < 0.5) {
        vx = 0;
      }
    }
  }

  function loop() {
    update();
    draw();
    if (x < canvas.width && (vx !== 0 || !rolling)) {
      requestAnimationFrame(loop);
    }
  }

  loop();
}

function updateLeaderboard(address, amount) {
  const leaderboard = document.getElementById('leaderboard-list');
  const entry = document.createElement('li');
  entry.innerText = `${address.slice(0, 4)}... swung ${amount} $SHUFF!`;
  leaderboard.appendChild(entry);
  document.getElementById('leaderboard').style.display = 'block';
}

document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);

document.getElementById('swing-btn').addEventListener('click', async () => {
  const amount = parseFloat(document.getElementById('swing-amount').value);
  if (!amount || amount <= 0) {
    alert('Enter a valid amount!');
    return;
  }
  await sendTransaction(amount);
});
</script>

</body>
</html>
