<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solana Golf Game ($SHUFF)</title>
  <script src="https://unpkg.com/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.3.9/dist/browser/index.iife.min.js"></script>
  <style>
    body { 
      font-family: 'Arial', sans-serif;
      background: #f0f8ff;
      color: #333;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    
    .game-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: clamp(1.5rem, 3vw, 2rem);
    }
    
    #game-canvas {
      background: #2ecc71;
      border-radius: 8px;
      margin: 20px auto;
      display: block;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 2/1;
    }
    
    #wallet-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      flex: 1 0 auto;
      min-width: 120px;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    
    #swing-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin: 15px 0;
    }
    
    input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      min-width: 200px;
      flex: 1 0 auto;
    }
    
    #status {
      margin: 15px 0;
      min-height: 20px;
      color: #e74c3c;
      font-weight: bold;
    }
    
    #loading-spinner {
      margin: 20px 0;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #leaderboard {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    #leaderboard-list {
      list-style: none;
      padding: 0;
      text-align: left;
    }
    
    #leaderboard-list li {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    
    #leaderboard-list li:last-child {
      border-bottom: none;
    }
    
    .tx-link {
      color: #3498db;
      text-decoration: none;
    }
    
    .tx-link:hover {
      text-decoration: underline;
    }
    
    @media (max-width: 600px) {
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
      
      #swing-input-container {
        flex-direction: column;
      }
      
      input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>üèåÔ∏è Solana Golf Game ($SHUFF)</h1>
    
    <div class="button-group">
      <button id="connect-wallet-btn">Connect Phantom Wallet</button>
      <button id="disconnect-btn" disabled>Disconnect</button>
      <button id="refresh-btn">üîÑ Refresh</button>
    </div>

    <div id="wallet-info" style="display:none;">
      <p>Wallet Address: <span id="wallet-address"></span></p>
      <p>Balance: <span id="wallet-balance">0</span> SHUFF</p>
      <p id="last-tx-info" style="display:none;">Last TX: <a href="#" id="last-tx-link" class="tx-link" target="_blank">View</a></p>
    </div>

    <div id="swing-input-container">
      <input type="number" id="swing-amount" placeholder="Enter SHUFF amount" min="0.1" step="0.1">
      <button id="swing-btn" disabled>Swing!</button>
    </div>

    <div id="status"></div>
    <div id="fee-estimate" style="margin: 10px 0; color: #7f8c8d;"></div>

    <div id="loading-spinner" style="display:none;">
      <div class="spinner"></div>
      <p>Processing transaction...</p>
    </div>

    <canvas id="game-canvas"></canvas>

    <div id="leaderboard">
      <h2>üèÜ Leaderboard</h2>
      <ul id="leaderboard-list"></ul>
    </div>
  </div>

  <script>
    // Game Configuration
    const shuffMint = new solanaWeb3.PublicKey('GGnZQxAcBXvhKJFX7bRosBhbm8v4uFBeBuTnZsfapump');
    const SHUFF_DECIMALS = 9;
    
    // Game State
    let walletAddress = null;
    let walletPublicKey = null;
    let connection = null;
    let animationFrameId = null;
    let lastTransactionSignature = null;

    // DOM Elements
    const connectBtn = document.getElementById('connect-wallet-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const walletAddressSpan = document.getElementById('wallet-address');
    const walletBalanceSpan = document.getElementById('wallet-balance');
    const swingAmountInput = document.getElementById('swing-amount');
    const swingBtn = document.getElementById('swing-btn');
    const statusDiv = document.getElementById('status');
    const feeEstimateDiv = document.getElementById('fee-estimate');
    const loadingSpinner = document.getElementById('loading-spinner');
    const leaderboardList = document.getElementById('leaderboard-list');
    const lastTxInfo = document.getElementById('last-tx-info');
    const lastTxLink = document.getElementById('last-tx-link');

    // Initialize Connection
    async function initializeConnection() {
      try {
        connection = new solanaWeb3.Connection(
          solanaWeb3.clusterApiUrl('mainnet-beta'),
          'confirmed'
        );
        
        // Test connection
        await connection.getEpochInfo();
        return true;
      } catch (err) {
        console.error("Connection error:", err);
        statusDiv.textContent = "Error connecting to Solana network. Please refresh.";
        statusDiv.style.color = "#e74c3c";
        return false;
      }
    }

    // Get SHUFF Token Balance with proper decimal handling
    async function getShuffBalance(publicKey) {
      try {
        const tokenAccount = await splToken.getAssociatedTokenAddress(
          shuffMint,
          publicKey
        );
        
        // Check if token account exists
        const accountExists = await connection.getAccountInfo(tokenAccount);
        if (!accountExists) return 0;
        
        // Create token instance
        const token = new splToken.Token(
          connection,
          shuffMint,
          solanaWeb3.TOKEN_PROGRAM_ID,
          null
        );
        
        // Get token account info
        const tokenAccountInfo = await token.getAccountInfo(tokenAccount);
        const balance = tokenAccountInfo.amount / Math.pow(10, SHUFF_DECIMALS);
        return balance.toFixed(2);
      } catch (err) {
        console.error("Balance check error:", err);
        return 0;
      }
    }

    // Connect Wallet
    async function connectWallet() {
      try {
        connectBtn.disabled = true;
        statusDiv.textContent = "Connecting to wallet...";
        
        if (!window.solana || !window.solana.isPhantom) {
          window.open('https://phantom.app/', '_blank');
          throw new Error("Phantom Wallet not installed! Redirecting...");
        }
        
        if (!connection) {
          const connected = await initializeConnection();
          if (!connected) return;
        }
        
        // Connect to wallet
        const response = await window.solana.connect();
        walletPublicKey = response.publicKey;
        walletAddress = walletPublicKey.toString();
        
        // Update UI
        walletAddressSpan.textContent = `${walletAddress.slice(0,4)}...${walletAddress.slice(-4)}`;
        document.getElementById('wallet-info').style.display = 'block';
        swingBtn.disabled = false;
        connectBtn.textContent = "Wallet Connected";
        disconnectBtn.disabled = false;
        
        // Get balance
        const balance = await getShuffBalance(walletPublicKey);
        walletBalanceSpan.textContent = balance;
        
        statusDiv.textContent = "Wallet connected successfully!";
        statusDiv.style.color = "#2ecc71";
        
        // Load leaderboard
        loadLeaderboard();
      } catch (err) {
        statusDiv.textContent = `Error: ${err.message}`;
        statusDiv.style.color = "#e74c3c";
        connectBtn.disabled = false;
        console.error("Connection error:", err);
      }
    }

    // Disconnect Wallet
    async function disconnectWallet() {
      try {
        if (window.solana && window.solana.isPhantom) {
          await window.solana.disconnect();
        }
        
        walletAddress = null;
        walletPublicKey = null;
        
        document.getElementById('wallet-info').style.display = 'none';
        connectBtn.textContent = "Connect Phantom Wallet";
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        swingBtn.disabled = true;
        walletBalanceSpan.textContent = "0";
        
        statusDiv.textContent = "Wallet disconnected";
        statusDiv.style.color = "#2ecc71";
      } catch (err) {
        console.error("Disconnection error:", err);
        statusDiv.textContent = "Error disconnecting wallet";
        statusDiv.style.color = "#e74c3c";
      }
    }

    // Load Leaderboard (placeholder - implement your actual leaderboard logic)
    async function loadLeaderboard() {
      leaderboardList.innerHTML = "<li>Loading leaderboard...</li>";
      // Implement your leaderboard fetching logic here
      setTimeout(() => {
        leaderboardList.innerHTML = `
          <li>1. Player1 - Hole in 1! üèÜ</li>
          <li>2. Player2 - 2 strokes</li>
          <li>3. Player3 - 3 strokes</li>
        `;
      }, 1000);
    }

    // Event Listeners
    connectBtn.addEventListener('click', connectWallet);
    disconnectBtn.addEventListener('click', disconnectWallet);
    refreshBtn.addEventListener('click', () => {
      window.location.reload();
    });
    
    swingBtn.addEventListener('click', async () => {
      const amount = parseFloat(swingAmountInput.value);
      if (!amount || amount <= 0) {
        statusDiv.textContent = "Please enter a valid amount";
        statusDiv.style.color = "#e74c3c";
        return;
      }
      
      // Implement your swing logic here
      statusDiv.textContent = `Swinging with ${amount} SHUFF...`;
      statusDiv.style.color = "#3498db";
      
      // This is where you would implement the golf game mechanics
      // For now, just show a message
      setTimeout(() => {
        statusDiv.textContent = "Swing complete! Implement game logic here.";
        statusDiv.style.color = "#2ecc71";
      }, 1500);
    });
    
    // Auto-connect if returning user
    window.addEventListener('load', async () => {
      try {
        if (window.solana && window.solana.isPhantom) {
          // Initialize connection first
          await initializeConnection();
          
          // Try silent connect
          const response = await window.solana.connect({ onlyIfTrusted: true });
          walletPublicKey = response.publicKey;
          walletAddress = walletPublicKey.toString();
          
          walletAddressSpan.textContent = `${walletAddress.slice(0,4)}...${walletAddress.slice(-4)}`;
          document.getElementById('wallet-info').style.display = 'block';
          swingBtn.disabled = false;
          connectBtn.textContent = "Wallet Connected";
          disconnectBtn.disabled = false;
          
          const balance = await getShuffBalance(walletPublicKey);
          walletBalanceSpan.textContent = balance;
          
          loadLeaderboard();
        }
      } catch (err) {
        console.log("Auto-connect skipped:", err);
      }
    });
    
    // Initialize the canvas for the golf game
    window.addEventListener('load', () => {
      const canvas = document.getElementById('game-canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas dimensions
      canvas.width = 800;
      canvas.height = 400;
      
      // Draw initial golf course
      drawGolfCourse(ctx, canvas.width, canvas.height);
    });

    // Draw golf course (placeholder)
    function drawGolfCourse(ctx, width, height) {
      // Green background
      ctx.fillStyle = '#2ecc71';
      ctx.fillRect(0, 0, width, height);
      
      // Fairway
      ctx.fillStyle = '#27ae60';
      ctx.beginPath();
      ctx.moveTo(50, height/2 - 50);
      ctx.lineTo(width - 100, height/2 - 50);
      ctx.lineTo(width - 50, height/2);
      ctx.lineTo(width - 100, height/2 + 50);
      ctx.lineTo(50, height/2 + 50);
      ctx.closePath();
      ctx.fill();
      
      // Hole
      ctx.fillStyle = 'black';
      ctx.beginPath();
      ctx.arc(width - 60, height/2, 5, 0, Math.PI * 2);
      ctx.fill();
      
      // Tee box
      ctx.fillStyle = '#f1c40f';
      ctx.fillRect(30, height/2 - 20, 40, 40);
      
      // Ball
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(50, height/2, 8, 0, Math.PI * 2);
      ctx.fill();
      
      // Flag
      ctx.fillStyle = 'red';
      ctx.fillRect(width - 60, height/2 - 30, 3, 30);
    }
  </script>
</body>
</html>
